apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "postgres.fullname" . }}-init-script
  labels:
    {{ include "postgres.labels" . | nindent 4 }}
data:
  init-multiple-databases.sh: |
    #!/bin/bash
    set -e

    echo "Starting multi-database initialization..."

    # Wait for PostgreSQL to be ready
    until pg_isready -U {{ .Values.postgres.superuser }}; do
      echo "Waiting for PostgreSQL to be ready..."
      sleep 2
    done

    echo "PostgreSQL is ready. Creating databases, users, and schemas..."

    {{- range .Values.databases }}
    DB="{{ .name }}"
    USER="{{ .user }}"
    PASSWORD="{{ .password }}"
    SCHEMA="{{ .schema }}"

    echo "Creating user $USER..."
    psql -v ON_ERROR_STOP=1 -U {{ $.Values.postgres.superuser }} <<-EOSQL || true
      DO \$\$
      BEGIN
        IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '$USER') THEN
          CREATE USER $USER WITH PASSWORD '$PASSWORD';
        END IF;
      END
      \$\$;
    EOSQL

    echo "Creating database $DB..."
    psql -v ON_ERROR_STOP=1 -U {{ $.Values.postgres.superuser }} <<-EOSQL || true
      SELECT 'CREATE DATABASE $DB OWNER $USER'
      WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '$DB')\gexec
    EOSQL

    echo "Creating schema $SCHEMA in database $DB..."
    psql -v ON_ERROR_STOP=1 -U {{ $.Values.postgres.superuser }} -d "$DB" <<-EOSQL || true
      CREATE SCHEMA IF NOT EXISTS $SCHEMA AUTHORIZATION $USER;
    EOSQL

    echo "Granting privileges on schema $SCHEMA for user $USER..."
    psql -v ON_ERROR_STOP=1 -U {{ $.Values.postgres.superuser }} -d "$DB" <<-EOSQL
      GRANT ALL ON SCHEMA $SCHEMA TO $USER;
      ALTER DEFAULT PRIVILEGES IN SCHEMA $SCHEMA GRANT ALL ON TABLES TO $USER;
      ALTER DEFAULT PRIVILEGES IN SCHEMA $SCHEMA GRANT ALL ON SEQUENCES TO $USER;
      ALTER USER $USER WITH CREATEDB;
    EOSQL

    # Update pg_hba.conf to allow connections
    echo "host $DB $USER 0.0.0.0 md5" >> $PGDATA/pg_hba.conf

    {{- end }}

    echo "Multi-database initialization completed!"
